{% extends "layout.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block content %}
<div class="col" style="padding:10px">
    <div class=smallheader>
        <h2>All Coins</h2>
    </div>
    <input type="text" id="tokenSearch" placeholder="Search tokens..." class="form-control">

    <table id="tickers-table">
        <thead>
            <tr>
                <th>Name</th>
                <th style="text-align: end;">Price</th>
            </tr>
        </thead>
        <tbody id="tickers-body">
            {% for coin, value in tickers.items %}
                <tr>
                    <td>{{ coin | format_coin}}</td>
                    <td style="text-align: end; font-size: 12px;">
                        {{value.last | intcomma}}
                        <br>
                        <small>Vol: {{value.vol_idr | intcomma}}</small></td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
const tokenSearch = document.getElementById('tokenSearch');
const tbody = document.getElementById('tickers-body');
const previousValues = {};

function formatNumber(num) {
    return num.toLocaleString('en-US');
}

function updateTickers() {
    fetch('/tickers-api/')
        .then(response => response.json())
        .then(data => {
            const searchTerm = tokenSearch.value.toLowerCase();
            tbody.innerHTML = '';

            for (const [coin, value] of Object.entries(data.tickers)) {
                const formattedCoin = coin.replace('_', '/').toUpperCase();
                const coinMatch = formattedCoin.toLowerCase().includes(searchTerm);

                if (!coinMatch) continue;

                const last = parseFloat(value.last);
                const vol = parseFloat(value.vol_idr);

                let flashClass = "";
                if (previousValues[coin]) {
                    if (last > previousValues[coin]) {
                        flashClass = "flash-green";
                    } else if (last < previousValues[coin]) {
                        flashClass = "flash-red";
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedCoin}</td>
                    <td style="text-align: end; font-size: 12px;">
                        <span class="price ${flashClass}">${formatNumber(last)}</span>
                        <br>
                        <small>Vol: ${formatNumber(vol)}</small>
                    </td>
                `;

                tbody.appendChild(row);
                previousValues[coin] = last;
            }

            setTimeout(() => {
                document.querySelectorAll('.flash-green, .flash-red').forEach(el => {
                    el.classList.remove('flash-green', 'flash-red');
                });
            }, 19000);
        });
}

// Initial load
updateTickers();

// Regular update
setInterval(updateTickers, 20000);

// Live filtering with data reload
tokenSearch.addEventListener('input', updateTickers);

</script>
    
{% endblock %}
